<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>策略测试</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .result {
        background: #f5f5f5;
        padding: 10px;
        margin: 10px 0;
        border-radius: 3px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 3px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .error {
        color: red;
        background: #ffe6e6;
      }
      .success {
        color: green;
        background: #e6ffe6;
      }
    </style>
  </head>
  <body>
    <h1>缓存策略测试</h1>

    <div class="test-section">
      <h2>策略测试</h2>
      <button onclick="testSmallData()">测试小数据 (localStorage)</button>
      <button onclick="testLargeData()">测试大数据 (IndexedDB)</button>
      <button onclick="testShortTTL()">测试短期缓存 (Memory)</button>
      <button onclick="testMediumTTL()">测试中期缓存 (SessionStorage)</button>
      <button onclick="testComplexObject()">测试复杂对象 (IndexedDB)</button>
      <button onclick="clearResults()">清空结果</button>
      <div id="results"></div>
    </div>

    <div class="test-section">
      <h2>加密测试</h2>
      <button onclick="testEncryption()">测试加密存储</button>
      <div id="encryption-results"></div>
    </div>

    <script type="module">
      import { createCache } from '../lib/index.js'

      // 创建启用策略的缓存实例
      const cache = createCache({
        strategy: {
          enabled: true,
          sizeThresholds: {
            small: 1024, // 1KB
            medium: 64 * 1024, // 64KB
            large: 1024 * 1024, // 1MB
          },
          ttlThresholds: {
            short: 5 * 60 * 1000, // 5分钟
            medium: 24 * 60 * 60 * 1000, // 24小时
            long: 7 * 24 * 60 * 60 * 1000, // 7天
          },
        },
        debug: true,
        security: {
          enabled: true,
          encryptionKey: 'test-key-123456789012345678901234',
        },
      })

      // 监听策略选择事件
      cache.on('strategy', (event) => {
        console.log('策略选择事件:', event)
        addResult(`策略选择: ${event.key} -> ${event.engine} (${event.strategy.reason})`, 'success')
      })

      // 监听错误事件
      cache.on('error', (event) => {
        console.error('缓存错误:', event)
        addResult(`错误: ${event.key} - ${event.error.message}`, 'error')
      })

      function addResult(message, type = '') {
        const results = document.getElementById('results')
        const div = document.createElement('div')
        div.className = `result ${type}`
        div.textContent = `${new Date().toLocaleTimeString()}: ${message}`
        results.appendChild(div)
      }

      function addEncryptionResult(message, type = '') {
        const results = document.getElementById('encryption-results')
        const div = document.createElement('div')
        div.className = `result ${type}`
        div.textContent = `${new Date().toLocaleTimeString()}: ${message}`
        results.appendChild(div)
      }

      // 测试函数
      window.testSmallData = async () => {
        try {
          const data = 'small data string'
          await cache.set('small-test', data)
          addResult(`小数据测试完成: ${data}`)
        } catch (error) {
          addResult(`小数据测试失败: ${error.message}`, 'error')
        }
      }

      window.testLargeData = async () => {
        try {
          // 生成大约100KB的数据
          const largeData = new Array(100000).fill('x').join('')
          await cache.set('large-test', largeData)
          addResult(`大数据测试完成: ${largeData.length} 字符`)
        } catch (error) {
          addResult(`大数据测试失败: ${error.message}`, 'error')
        }
      }

      window.testShortTTL = async () => {
        try {
          const data = 'short ttl data'
          await cache.set('short-ttl-test', data, { ttl: 3000 }) // 3秒
          addResult(`短期缓存测试完成: ${data}`)
        } catch (error) {
          addResult(`短期缓存测试失败: ${error.message}`, 'error')
        }
      }

      window.testMediumTTL = async () => {
        try {
          const data = 'medium ttl data'
          await cache.set('medium-ttl-test', data, { ttl: 60 * 60 * 1000 }) // 1小时
          addResult(`中期缓存测试完成: ${data}`)
        } catch (error) {
          addResult(`中期缓存测试失败: ${error.message}`, 'error')
        }
      }

      window.testComplexObject = async () => {
        try {
          const complexData = {
            id: 1,
            name: '复杂对象',
            data: new Array(1000).fill(0).map((_, i) => ({ id: i, value: Math.random() })),
            nested: {
              level1: {
                level2: {
                  level3: 'deep value',
                },
              },
            },
          }
          await cache.set('complex-test', complexData)
          addResult(`复杂对象测试完成: ${JSON.stringify(complexData).length} 字符`)
        } catch (error) {
          addResult(`复杂对象测试失败: ${error.message}`, 'error')
        }
      }

      window.testEncryption = async () => {
        try {
          const sensitiveData = {
            username: 'admin',
            password: 'secret123',
            token: 'jwt-token-here',
          }
          await cache.set('encrypted-test', sensitiveData, { encrypt: true })

          // 尝试读取
          const retrieved = await cache.get('encrypted-test')
          if (retrieved && retrieved.username === 'admin') {
            addEncryptionResult('加密测试成功: 数据正确加密和解密', 'success')
          } else {
            addEncryptionResult('加密测试失败: 数据不匹配', 'error')
          }
        } catch (error) {
          addEncryptionResult(`加密测试失败: ${error.message}`, 'error')
        }
      }

      window.clearResults = () => {
        document.getElementById('results').innerHTML = ''
        document.getElementById('encryption-results').innerHTML = ''
      }

      // 页面加载完成后显示初始信息
      window.addEventListener('load', () => {
        addResult('缓存系统已初始化，策略已启用')
      })
    </script>
  </body>
</html>
